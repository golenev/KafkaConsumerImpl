version: '3.8'

services:
  redpanda:
    image: redpandadata/redpanda:v23.3.11
    container_name: validator-redpanda
    command:
      - bash
      - -c
      - |
        redpanda start --overprovisioned --smp 1 --memory 1G --reserve-memory 0M --node-id 0 --check=false \
          --kafka-addr PLAINTEXT://0.0.0.0:9092,PLAINTEXT://redpanda:9093 \
          --advertise-kafka-addr PLAINTEXT://localhost:9092,PLAINTEXT://redpanda:9093 \
          --pandaproxy-addr 0.0.0.0:8082 --advertise-pandaproxy-addr localhost:8082 \
          --schema-registry-addr 0.0.0.0:8081 &
        pid=$!
        until rpk cluster info --brokers localhost:9092 >/dev/null 2>&1; do sleep 1; done
        rpk topic create out_validator --brokers localhost:9092 --replicas 1 --partitions 3 || true
        wait ${pid}
    ports:
      - "8817:9092"
      - "8081:8081"
      - "8082:8082"
    environment:
      - RPK_CLUSTER_NAME=validator-cluster
    healthcheck:
      test: ["CMD", "rpk", "cluster", "info", "--brokers", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  redpanda-console:
    image: docker.redpanda.com/vectorized/console:v2.7.2
    container_name: validator-redpanda-console
    depends_on:
      redpanda:
        condition: service_healthy
    environment:
      KAFKA_BROKERS: redpanda:9093
      KAFKA_TLS_ENABLED: "false"
      CONSOLE_LISTEN_ADDRESS: 0.0.0.0:8080
      CONSOLE_DEFAULT_TOPIC: out_validator
    ports:
      - "8080:8080"
