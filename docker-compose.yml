version: "3.8"

services:
  redpanda:
    image: redpandadata/redpanda:v23.3.11
    container_name: validator-redpanda
    command:
      - bash
      - -c
      - |
        set -euo pipefail
        redpanda start --mode dev-container --smp 1 --memory 1G --overprovisioned --reserve-memory 0M \
          --node-id 0 --check=false \
          --kafka-addr PLAINTEXT://0.0.0.0:9092,PLAINTEXT://redpanda:9092 \
          --advertise-kafka-addr PLAINTEXT://localhost:8817,PLAINTEXT://redpanda:9092 \
          --set redpanda.enable_sasl=true \
          --set redpanda.superusers=validator_user &
        pid=$!
        trap "kill -TERM ${pid} 2>/dev/null || true" EXIT
        until rpk cluster info --api-urls localhost:9644 >/dev/null 2>&1; do sleep 1; done
        rpk acl user create --api-urls localhost:9644 --new-username validator_user --new-password validator_pass --mechanism SCRAM-SHA-256 || true
        rpk topic create in_validator --brokers localhost:9092 --replicas 1 --partitions 3 --user validator_user --password validator_pass --sasl-mechanism SCRAM-SHA-256 || true
        rpk topic create out_validator --brokers localhost:9092 --replicas 1 --partitions 3 --user validator_user --password validator_pass --sasl-mechanism SCRAM-SHA-256 || true
        wait ${pid}
    ports:
      - "8817:9092"
    environment:
      - RPK_CLUSTER_NAME=validator-cluster
    healthcheck:
      test:
        [
          "CMD",
          "rpk",
          "cluster",
          "info",
          "--brokers",
          "localhost:9092",
          "--user",
          "validator_user",
          "--password",
          "validator_pass",
          "--sasl-mechanism",
          "SCRAM-SHA-256",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: redpanda-console
    depends_on:
      redpanda:
        condition: service_healthy
    ports:
      - "8055:8080"
    environment:
      KAFKA_BROKERS: "redpanda:9092"
      KAFKA_SASL_ENABLED: "true"
      KAFKA_SASL_USERNAME: "validator_user"
      KAFKA_SASL_PASSWORD: "validator_pass"
      KAFKA_SASL_MECHANISM: "SCRAM-SHA-256"
      CONSOLE_DEFAULT_TOPIC: out_validator
