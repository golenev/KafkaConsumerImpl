version: "3.8"

services:
  redpanda:
    image: redpandadata/redpanda:v23.3.11
    container_name: validator-redpanda
    command:
      - bash
      - -c
      - |
        redpanda start --mode dev-container --smp 1 --memory 1G --overprovisioned --reserve-memory 0M \
          --node-id 0 --check=false \
          --kafka-addr PLAINTEXT://0.0.0.0:9092,PLAINTEXT://redpanda:9092 \
          --advertise-kafka-addr PLAINTEXT://localhost:8817,PLAINTEXT://redpanda:9092 \
          --set redpanda.enable_sasl=true &
        pid=$!
        until rpk cluster info --brokers localhost:9092 >/dev/null 2>&1; do sleep 1; done
        rpk acl user create validator_user --password validator_pass --mechanism SCRAM-SHA-256 --brokers localhost:9092 || true
        rpk acl create --allow-principal user:validator_user --operation all --topic out_validator --brokers localhost:9092 || true
        rpk topic create out_validator --brokers localhost:9092 --replicas 1 --partitions 3 || true
        wait ${pid}
    ports:
      - "8817:9092"
    environment:
      - RPK_CLUSTER_NAME=validator-cluster
    healthcheck:
      test: ["CMD", "rpk", "cluster", "info", "--brokers", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: redpanda-console
    depends_on:
      redpanda:
        condition: service_healthy
    ports:
      - "8055:8080"
    environment:
      KAFKA_BROKERS: "redpanda:9092"
      KAFKA_SASL_ENABLED: "true"
      KAFKA_SASL_USERNAME: "validator_user"
      KAFKA_SASL_PASSWORD: "validator_pass"
      KAFKA_SASL_MECHANISM: "SCRAM-SHA-256"
      CONSOLE_DEFAULT_TOPIC: out_validator
